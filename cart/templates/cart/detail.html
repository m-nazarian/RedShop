{% extends 'parent/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯{% endblock %}

{% block content %}
<main class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-7xl">

        <div class="flex items-center gap-2 mb-6">
            <h1 class="text-xl font-bold text-gray-800">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§</h1>
            <span class="text-sm text-gray-500">({{ cart|length|fa_number }} Ú©Ø§Ù„Ø§)</span>
        </div>

        {% if cart|length > 0 %}
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <div class="lg:col-span-8 space-y-4">

                    {% for item in cart %}
                        <div class="product-item bg-white border border-gray-200 rounded-xl p-4 sm:p-6 shadow-sm flex flex-col sm:flex-row gap-6 relative group" data-item-id="{{ item.product.id }}">

                            <a href="{{ item.product.get_absolute_url }}" class="shrink-0 mx-auto sm:mx-0">
                                {% if item.product.images.first %}
                                    <img src="{{ item.product.images.first.file.url }}" alt="{{ item.product.name }}" class="w-32 h-32 object-contain mix-blend-multiply">
                                {% else %}
                                    <div class="w-32 h-32 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">ğŸ“·</div>
                                {% endif %}
                            </a>

                            <div class="flex-1 flex flex-col justify-between">
                                <div>
                                    <h3 class="text-base font-bold text-gray-800 leading-7 mb-2">
                                        <a href="{{ item.product.get_absolute_url }}" class="hover:text-blue-600 transition-colors">
                                            {{ item.product.name|fa_number }}
                                        </a>
                                    </h3>

                                    <div class="flex flex-wrap gap-2 text-xs text-gray-500 mb-4">
                                        {% if item.product.category %}
                                            <span class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded">
                                                ğŸ“‚ {{ item.product.category.name }}
                                            </span>
                                        {% endif %}
                                        </div>
                                </div>

                                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-4 sm:mt-0">

                                    <div class="flex items-center border border-gray-200 rounded-lg h-10">
                                        <button class="quantity-add px-3 text-gray-600 hover:text-blue-600 hover:bg-gray-50 h-full text-lg font-bold transition-colors">+</button>
                                        <span id="item-quantity-{{ item.product.id }}" class="w-10 text-center text-gray-800 font-medium select-none">{{ item.quantity|fa_number }}</span>
                                        <button class="quantity-decrease px-3 text-gray-600 hover:text-red-500 hover:bg-gray-50 h-full text-lg font-bold transition-colors">-</button>
                                    </div>

                                    <div class="text-left">
                                        <div class="text-xs text-gray-400 mb-1">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: {{ item.price|money_format }}</div>
                                        <div class="text-lg font-bold text-gray-800">
                                            <span id="item-total-{{ item.product.id }}">{{ item.total|money_format }}</span> <span class="text-xs font-normal">ØªÙˆÙ…Ø§Ù†</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button class="quantity-remove absolute top-4 left-4 text-gray-300 hover:text-red-500 transition-colors p-1" title="Ø­Ø°Ù Ø§Ø² Ø³Ø¨Ø¯">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    {% endfor %}
                </div>

                <div class="lg:col-span-4">
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 sticky top-4 space-y-6">

                        <h2 class="text-lg font-bold text-gray-800 border-b border-gray-100 pb-4">Ø®Ù„Ø§ØµÙ‡ Ø³ÙØ§Ø±Ø´</h2>

                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                            {% if cart.coupon %}
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-green-600 font-bold flex items-center gap-1">
                                        ğŸŸï¸ Ú©Ø¯ ØªØ®ÙÛŒÙ: {{ cart.coupon.code }} ({{ cart.coupon.discount|fa_number }}%)
                                    </span>
                                    </div>
                                <p class="text-xs text-gray-500 mt-2">ØªØ®ÙÛŒÙ Ø±ÙˆÛŒ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.</p>
                            {% else %}
                                <p class="text-xs text-gray-500 mb-2">Ú©Ø¯ ØªØ®ÙÛŒÙ Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
                                <form action="{% url 'coupons:apply' %}" method="post" class="flex gap-2">
                                    {% csrf_token %}
                                    <input type="text" name="code" placeholder="Ú©Ø¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 text-center" required>
                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">Ø«Ø¨Øª</button>
                                </form>
                            {% endif %}

                            {% if messages %}
                                <div class="mt-2 space-y-1">
                                    {% for message in messages %}
                                        <p class="text-xs {% if message.tags == 'success' %}text-green-600{% else %}text-red-500{% endif %}">
                                            {{ message }}
                                        </p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="space-y-3 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Ù‚ÛŒÙ…Øª Ú©Ø§Ù„Ø§Ù‡Ø§</span>
                                <span class="font-medium text-gray-800"><span id="item-total-price">{{ cart.get_total_price|money_format }}</span> ØªÙˆÙ…Ø§Ù†</span>
                            </div>

                            <div class="flex justify-between">
                                <span>Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</span>
                                <span class="font-medium text-gray-800"><span id="item-post-price">{{ cart.get_post_price_if_any|money_format }}</span> ØªÙˆÙ…Ø§Ù†</span>
                            </div>

                            {% if cart.coupon %}
                                <div class="flex justify-between text-red-500">
                                    <span>Ø³ÙˆØ¯ Ø´Ù…Ø§ Ø§Ø² Ø®Ø±ÛŒØ¯ (ØªØ®ÙÛŒÙ)</span>
                                    <span class="font-bold"><span>{{ cart.get_discount|money_format }}</span> ØªÙˆÙ…Ø§Ù†</span>
                                </div>
                            {% endif %}
                        </div>

                        <div class="border-t border-gray-100 pt-4 flex justify-between items-center">
                            <span class="font-bold text-gray-800">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</span>
                            <span class="text-xl font-bold text-blue-600"><span id="item-final-price">{{ cart.get_final_price|money_format }}</span> <span class="text-sm font-normal text-gray-500">ØªÙˆÙ…Ø§Ù†</span></span>
                        </div>

                        <div class="space-y-3 pt-2">
                            <a href="{% url 'orders:checkout_address' %}" class="block w-full bg-red-500 hover:bg-red-600 text-white text-center font-bold py-3 rounded-xl shadow-lg shadow-red-500/30 transition-all">
                                Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø®Ø±ÛŒØ¯
                            </a>
                            <a href="{% url 'shop:product_list' %}" class="block w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-center font-medium py-3 rounded-xl transition-colors">
                                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡
                            </a>
                        </div>

                    </div>
                </div>
            </div>

        {% else %}
            <div class="flex flex-col items-center justify-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                <div class="w-32 h-32 bg-gray-50 rounded-full flex items-center justify-center mb-6 text-6xl">
                    â˜¹ï¸
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!</h2>
                <p class="text-gray-500 mb-8">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±ÙˆÛŒØ¯.</p>
                <a href="{% url 'shop:product_list' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-600/30 transition-all">
                    Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª
                </a>
            </div>
        {% endif %}

    </div>
</main>

<script src="{% static '/jquery.min.js' %}"></script>
<script>
    // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¹Ø¯Ø¯
    function toPersianNumberWithCommas(n) {
        if (n === null || n === undefined) return "0";
        const numStr = n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return numStr.replace(/\d/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);
    }

    // ØªØ§Ø¨Ø¹ Ø³Ø§Ø¯Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø±Ù‚Ù… (Ø¨Ø±Ø§ÛŒ Ø¨Ø¬ Ù‡Ø¯Ø±)
    function toPersianNum(num) {
        return num.toString().replace(/\d/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);
    }

    $(document).ready(function(){

        // Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        $('.quantity-add').on('click', function(){
            const itemContainer = $(this).closest('.product-item');
            updateQuantity(itemContainer.data('item-id'), 'add');
        });

        $('.quantity-decrease').on('click', function(){
            const itemContainer = $(this).closest('.product-item');
            updateQuantity(itemContainer.data('item-id'), 'decrease');
        });

        $('.quantity-remove').on('click', function(){
            const itemId = $(this).closest('.product-item').data('item-id');
            if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                removeItem(itemId);
            }
        });

        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¢Ù¾Ø¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯
        function updateQuantity(itemId, action){
            $.ajax({
                type: 'POST',
                url: '{% url 'cart:update_quantity' %}',
                data: {
                    'item_id': itemId,
                    'action': action,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response){
                    if (response.success){
                        // 1. Ø¢Ù¾Ø¯ÛŒØª Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ ØµÙØ­Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
                        $('#item-quantity-'+ itemId).text(toPersianNumberWithCommas(response.quantity));
                        $('#item-total-'+ itemId).text(toPersianNumberWithCommas(response.item_total));

                        // Ø¢Ù¾Ø¯ÛŒØª Ø®Ù„Ø§ØµÙ‡ ÙØ§Ú©ØªÙˆØ±
                        $('#item-total-price').text(toPersianNumberWithCommas(response.total_price));
                        $('#item-post-price').text(toPersianNumberWithCommas(response.post_price));
                        $('#item-final-price').text(toPersianNumberWithCommas(response.final_price));

                        if (response.discount_amount) {
                             $('#discount-amount-display').text(toPersianNumberWithCommas(response.discount_amount));
                        }

                        // 2. Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¬ Ù‚Ø±Ù…Ø² Ø±Ù†Ú¯ Ø¯Ø± Ù‡Ø¯Ø± (Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§ main.js)
                        const headerBadge = $('#header-cart-count');
                        if(headerBadge.length) {
                            headerBadge.text(toPersianNum(response.item_count));
                            if(response.item_count > 0) headerBadge.removeClass('hidden');
                            else headerBadge.addClass('hidden');
                        }

                        // 3. Ø¢Ù¾Ø¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± ØªÛŒØªØ± Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
                        $('#item_count').text(toPersianNumberWithCommas(response.item_count));


                    } else {
                        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨Ø§ showToast ÛŒØ§ Ø¢Ù„Ø±Øª
                        if (typeof showToast === 'function') {
                            showToast(response.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯', 'error');
                        } else {
                            alert(response.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯');
                        }
                    }
                },
                error: function(xhr) {
                    console.error(xhr);
                    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±
                    let msg = 'Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.';
                    if(xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
                    if (typeof showToast === 'function') showToast(msg, 'error');
                }
            });
        }

        // ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ø¢ÛŒØªÙ…
        function removeItem(itemId){
            $.ajax({
                type: 'POST',
                url: '{% url 'cart:remove_item' %}',
                data: {
                    'item_id': itemId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response){
                    if (response.success){
                        // Ø­Ø°Ù Ø¨ØµØ±ÛŒ
                        $(`.product-item[data-item-id=${itemId}]`).fadeOut(300, function(){ $(this).remove(); });

                        // Ø¢Ù¾Ø¯ÛŒØª Ø®Ù„Ø§ØµÙ‡ ÙØ§Ú©ØªÙˆØ±
                        $('#item-total-price').text(toPersianNumberWithCommas(response.total_price));
                        $('#item-post-price').text(toPersianNumberWithCommas(response.post_price));
                        $('#item-final-price').text(toPersianNumberWithCommas(response.final_price));

                        // Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¬ Ù‡Ø¯Ø±
                        const headerBadge = $('#header-cart-count');
                        if(headerBadge.length) {
                            headerBadge.text(toPersianNum(response.item_count));
                            if(response.item_count === 0) headerBadge.addClass('hidden');
                        }

                        // Ø±ÛŒÙ„ÙˆØ¯ Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø´Ø¯
                        if(response.item_count === 0) {
                            setTimeout(() => location.reload(), 500);
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}