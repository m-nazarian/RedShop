{% load custom_filters %}

<div class="space-y-6 animate-fade-in">

    <div class="flex items-center justify-between border-b border-gray-200 pb-4">
        <h3 class="text-lg font-bold text-gray-800">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
        <button onclick="loadProfileContent('{% url 'orders:user_orders_partial' %}')" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
            Ø§Ù†ØµØ±Ø§Ù âœ•
        </button>
    </div>

    <form id="profile-edit-form" action="{% url 'account:edit_profile_partial' %}" method="post" enctype="multipart/form-data" class="space-y-8">
        {% csrf_token %}

        <div class="bg-gray-50 p-5 rounded-xl border border-gray-100">
            <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                <span>ğŸ‘¤</span> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                {% for field in user_form %}
                    <div class="form-group">
                        <label class="block text-xs font-medium text-gray-500 mb-1">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <p class="text-xs text-red-500 mt-1">{{ field.errors.0 }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="bg-gray-50 p-5 rounded-xl border border-gray-100">
            <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                <span>ğŸ“‹</span> Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                {% for field in account_form %}
                    <div class="form-group {% if field.name == 'photo' %}md:col-span-2{% endif %}">
                        <label class="block text-xs font-medium text-gray-500 mb-1">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <p class="text-xs text-red-500 mt-1">{{ field.errors.0 }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="flex justify-end pt-4">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-600/30 transition-all flex items-center gap-2">
                <span>ğŸ’¾</span> Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
            </button>
        </div>
    </form>
</div>

<script>
    document.getElementById('profile-edit-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = this;
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        const formData = new FormData(form);

        // Ù„ÙˆØ¯ÛŒÙ†Ú¯
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent mr-2"></span> Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
                // Ø±ÛŒÙ„ÙˆØ¯ Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ù‡Ø¯Ø± Ùˆ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±Ù… Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'error');

                // Ø§Ú¯Ø± Ø³Ø±ÙˆØ± HTML ÙØ±Ù… Ø±Ùˆ Ø¨Ø§ Ø§Ø±ÙˆØ± ÙØ±Ø³ØªØ§Ø¯:
                if (data.html_form) {
                    document.getElementById('profile-dynamic-content').innerHTML = data.html_form;
                }
            }
        })
        .catch(err => {
            console.error(err);
            showToast('Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });
</script>